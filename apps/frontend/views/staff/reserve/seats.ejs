<h1>座席選択</h1>

<% if (req.query.message) { %>
<div class="alert alert-danger" role="alert">
    <a href="javascript:void(0)" class="close" data-dismiss="alert" aria-label="close">&times;</a>
    <%- req.query.message %>
</div>
<% } %>

<%- include('./_reservationModel') %>

<%- include('./_step') %>

<div class="row">
    <div class="row">
        <dl>
            <dt><dt>
            <dd>空席</dd>
            <dt><dt>
            <dd class="bg-primary">選択した席</dd>
            <dt><dt>
            <dd class="bg-danger">購入済みの席</dd>
        </dl>
    </div>


    <div class="table-responsive">
        <table class="table table-bordered">

            <tbody>
                <tr>
                <% performance.screen.sections[0].seats.forEach(function(seat, index) { %>
                    <% if (index % 12 === 0) { %>
                    </tr>
                    <tr>
                    <% } %>

                    <% if (performanceSeatDocumentsBySeatCode.hasOwnProperty(seat.get('code'))) { %>

                        <% if (reservationDocumentsBySeatCode.hasOwnProperty(seat.get('code'))) { %>
                            <% if (reservationModel.seatCodes && reservationModel.seatCodes.indexOf(seat.get('code')) >= 0) { %>
                                <!-- 自分自身が仮押さえ中 -->
                                <th scope="row" class="select-seat bg-primary" data-seat-code="<%- seat.get('code') %>">
                                    <a tabindex="0" class="popover-reservation"
                                         data-seat-code="<%- seat.get('code') %>"
                                        data-toggle="popover"
                                        data-trigger="focus"><%- seat.get('code') %></a>
                                </th>

                            <% } else { %>
                                <!-- 他プロセスによって予約不可 -->
                                <% let reservationDocument = reservationDocumentsBySeatCode[seat.get('code')] %>
                                <th scope="row" class="bg-danger">
                                    <a tabindex="0" class="popover-reservation"
                                        data-seat-code="<%- seat.get('code') %>"
                                        data-toggle="popover"
                                        data-trigger="focus"><%- seat.get('code') %></a>
                                </th>
                            <% } %>

                        <% } else { %>
                            <!-- 予約可能 -->
                            <th scope="row" class="select-seat" data-seat-code="<%- seat.get('code') %>">
                                <%- seat.get('code') %>
                            </th>
                        <% } %>

                    <% } else { %>
                        <!-- 未販売 -->
                        <th scope="row" class="bg-warning text-muted">
                            <%- seat.get('code') %>
                        </th>

                    <% } %>

                <% }) %>
                </tr>
            </tbody>

        </table>
    </div>

    <a class="btn btn-default btn-lg btn-block" href="<%- url('staff.reserve.performances', {token: req.params.token}) %>">戻る</a>
    <a class="btn btn-primary btn-lg btn-block select-seats" href="javascript:void(0);">券種選択</a>
</div>


<script>
var reservationDocumentsBySeatCode = <%- JSON.stringify(reservationDocumentsBySeatCode) %>
$(function(){
    $('.select-seat').on('click', function(){
        $(this).toggleClass('bg-primary');
    });

    $('.select-seats').on('click', function(){
        var codes = [];

        // 座席コードリストを取得
        $('.select-seat.bg-primary').each(function(index){
            codes.push($(this).attr('data-seat-code'));
        });

        if (codes.length < 1) {
            alert('座席を選択してください');
        } else {
            $('form input[name="codes"]').val(JSON.stringify(codes));
            $('form').submit();
        }
    });

    // 予約の吹き出し
    $('.popover-reservation').popover({
        placement: 'top',
        html: true,
        content: function(){
            var seatCode = $(this).attr('data-seat-code');
            var reservation = reservationDocumentsBySeatCode[seatCode];

            if (reservation.staff) {
                return `
${reservation.staff_department_name}<br>
${reservation.staff_name}
                `;
            } else if (reservation.sponsor) {
                return `
外部関係者<br>
${reservation.sponsor_name}
                `;
            } else {
                return `
一般<br>
${reservation.profile_email}
                `;
            }
        }
    });
});
</script>

<form method="post">
<%- form.toHTML() %>
</form>

