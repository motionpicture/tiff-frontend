<h1>座席選択</h1>

<%- include('./_reservationModel') %>

<%- include('./_step') %>

<div class="row">
    <div class="table-responsive tickets">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>座席No</th>
                    <th>券種</th>
                </tr>
            </thead>

            <tbody>
                <% for (let seatDocument of seatDocuments) { %>
                <tr data-seat-code="<%- seatDocument.get('code') %>">
                    <td><%- seatDocument.get('code') %></td>
                    <td>
                        <select class="form-control">

                            <!-- TODO ひとまず固定 -->
                            <option
                                value="01"
                                data-name="無料"
                                data-name-en="free"
                                data-price="0">無料
                            </option>
                            <option
                                value="02"
                                data-name="有料"
                                data-name-en="charge"
                                data-price="1500">有料
                            </option>

                        </select>

                        <input type="text" name="watcherName" class="form-control" placeholder="ご鑑賞者氏名をご記入ください"
                            <% if (ticketChoicesBySeatCode.hasOwnProperty(seatDocument.get('code'))) { %>
                            value="<%- ticketChoicesBySeatCode[seatDocument.get('code')].watcher_name %>"
                            <% } else { %>
                            value=""
                            <% } %>
                         >

                    </td>
                </tr>
                <% } %>

            </tbody>
        </table>
    </div>

    <a class="btn btn-default btn-lg btn-block" href="<%- url('staff.reserve.seats', {token: req.params.token}) %>">戻る</a>
    <a class="btn btn-primary btn-lg btn-block select-tickets" href="javascript:void(0);">次へ</a>
</div>


<script>
$(function(){
    $('.select-tickets').on('click', function(){
        // 座席コードリストを取得
        var choices = [];
        $('.tickets tbody tr').each(function(index){
            choices.push({
                seat_code: $(this).attr('data-seat-code'),
                watcher_name: $('input', this).val(),
                ticket: {
                    type: $('select', this).val(),
                    name: $('option:selected', this).attr('data-name'),
                    name_en: $('option:selected', this).attr('data-name-en'),
                    price: $('option:selected', this).attr('data-price'),
                }
            });
        });

        $('form input[name="choices"]').val(JSON.stringify(choices));
        $('form').submit();
    });

});
</script>

<form method="post">
<%- form.toHTML() %>
</form>

