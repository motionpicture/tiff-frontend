<h1>座席選択</h1>

<% if (req.query.message) { %>
<div class="alert alert-danger" role="alert">
    <a href="javascript:void(0)" class="close" data-dismiss="alert" aria-label="close">&times;</a>
    <%- req.query.message %>
</div>
<% } %>

<%- include('./_reservationModel') %>

<%- include('./_step') %>

<div class="row">
    <div class="row">
    <h3>取得可能枚数残り : <span class="reservable-count"><%- parseInt(sponsorUser.get('max_reservation_count')) - reservationsCount %></span>枚</h3>
    </div>

    <div class="row">
        <dl>
            <dt><dt>
            <dd>空席</dd>
            <dt><dt>
            <dd class="bg-primary">選択した席</dd>
            <dt><dt>
            <dd class="bg-danger">購入済みの席</dd>
        </dl>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered">

            <tbody>
                <tr>
                <% performance.screen.sections[0].seats.forEach(function(seat, index) { %>
                    <% if (index % 12 === 0) { %>
                    </tr>
                    <tr>
                    <% } %>

                    <% if (performanceSeatDocumentsBySeatCode.hasOwnProperty(seat.get('code'))) { %>

                        <% if (reservationDocumentsBySeatCode.hasOwnProperty(seat.get('code'))) { %>
                            <% if (reservationModel.seatCodes && reservationModel.seatCodes.indexOf(seat.get('code')) >= 0) { %>
                                <!-- 仮押さえ中 -->
                                <th scope="row" class="select-seat bg-primary" data-seat-code="<%- seat.get('code') %>">
                                    <%- seat.get('code') %>
                                </th>
                            <% } else { %>
                                <!-- 予約不可 -->
                                <th scope="row" class="bg-danger">
                                    <%- seat.get('code') %>
                                </th>
                            <% } %>

                        <% } else { %>
                            <!-- 予約可能 -->
                            <th scope="row" class="select-seat" data-seat-code="<%- seat.get('code') %>">
                                <%- seat.get('code') %>
                            </th>
                        <% } %>

                    <% } else { %>
                        <!-- 未販売 -->
                        <th scope="row" class="bg-warning text-muted">
                            <%- seat.get('code') %>
                        </th>

                    <% } %>

                <% }) %>
                </tr>
            </tbody>

        </table>
    </div>

    <a class="btn btn-default btn-lg btn-block" href="<%- url('sponsor.reserve.performances', {token: req.params.token}) %>">戻る</a>
    <a class="btn btn-primary btn-lg btn-block select-seats" href="javascript:void(0);">券種選択</a>
</div>


<script>
$(function(){
    $('.select-seat').on('click', function(){
        var count = parseInt($('.reservable-count').text());

        if ($(this).hasClass('bg-primary')) {
            $('.reservable-count').text(count + 1);
        } else {
            $('.reservable-count').text(count - 1);
        }

        $(this).toggleClass('bg-primary');
    });

    $('.select-seats').on('click', function(){
        var codes = [];

        // 座席コードリストを取得
        $('.select-seat.bg-primary').each(function(index){
            codes.push($(this).attr('data-seat-code'));
        });

        if (codes.length < 1) {
            alert('座席を選択してください');
        } else {
            $('form input[name="codes"]').val(JSON.stringify(codes));
            $('form').submit();
        }
    });
});
</script>

<form method="post">
<%- form.toHTML() %>
</form>

