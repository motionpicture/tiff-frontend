<h1>座席選択</h1>

<div class="row">
    <div class="col-md-6">
        <div class="table-responsive">
            <table class="table table-bordered">

                <tbody>
                    <tr>
                    <% seats.forEach(function(seat, index) { %>
                        <% if (index % 12 === 0) { %>
                        </tr>
                        <tr>
                        <% } %>
                            <% if (seat.status === '0') { %>
                            <th scope="row" class="select-seat" data-code="<%- seat.code %>">
                                <%- seat.code %>
                            </th>
                            <% } else { %>
                            <th scope="row" class="bg-danger">
                                <%- seat.code %>
                            </th>
                            <% } %>

                    <% }) %>
                    </tr>
                </tbody>

            </table>
        </div>

        <a class="btn btn-default btn-lg btn-block" href="<%- url('customer.reserve.performances', {token: req.params.token}) %>">戻る</a>
        <a class="btn btn-default btn-lg btn-block show-tickets" href="javascript:void(0);">券種選択</a>
    </div>

    <div class="col-md-6 tickets hidden">
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>座席No</th>
                        <th>券種</th>
                    </tr>
                </thead>

                <tbody>
                    <% seats.forEach(function(seat, index) { %>
                    <tr data-code="<%- seat.code %>" class="hidden">
                        <td><%- seat.code %></td>
                        <td>
                            <select class="form-control">
                            <% seat.tickets.forEach(function(ticket, index) { %>
                            <option value="<%- ticket.type %>" data-name="<%- ticket.name %>" data-name-en="<%- ticket.name_en %>" data-price="<%- ticket.price %>"><%- ticket.name %> <%- ticket.price %>円</option>
                            <% }) %>
                            </select>
                        </td>
                    </tr>

                    <% }) %>

                </tbody>
            </table>
        </div>

        <a class="btn btn-default btn-lg btn-block" href="javascript:void(0);">戻る</a>
        <a class="btn btn-default btn-lg btn-block select-tickets" href="javascript:void(0);">次へ</a>

    </div>
</div>


<script>
$(function(){
    $('.select-seat').on('click', function(){
        var seatCode = $(this).attr('data-code');

        $(this).toggleClass('bg-primary');

        return;
    });

    $('.show-tickets').on('click', function(){
        $(`.tickets tbody tr`).addClass('hidden');

        // 座席コードリストを取得
        $('.select-seat.bg-primary').each(function(index){
            var seatCode = $(this).attr('data-code');
            $(`.tickets tbody tr[data-code="${seatCode}"]`).removeClass('hidden');
        });

        $('.tickets').removeClass('hidden');
    });

    $('.select-tickets').on('click', function(){
        // 座席コードリストを取得
        var choices = [];
        $('.tickets tbody tr').not('.hidden').each(function(index){
            choices.push({
                code: $(this).attr('data-code'),
                ticket: {
                    type: $('select', this).val(),
                    name: $('option:selected', this).attr('data-name'),
                    name_en: $('option:selected', this).attr('data-name-en'),
                    price: $('option:selected', this).attr('data-price'),
                }
            });
        });

        $('form input[name="choices"]').val(JSON.stringify(choices));
        $('form').submit();
    });

});
</script>

<form method="post">
<%- form.toHTML() %>
</form>

